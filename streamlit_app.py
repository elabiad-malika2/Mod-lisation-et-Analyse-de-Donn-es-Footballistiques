"""
Dashboard Footballistiques - Premier League 2024-2025
Application Streamlit simple avec connexion PostgreSQL
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from sqlalchemy import create_engine, MetaData, Table, select, func, desc, case

# Configuration de la page
st.set_page_config(
    page_title="Dashboard Footballistiques",
    page_icon="âš½",
    layout="wide"
)

# ============================================
# 1. Connexion Ã  la base de donnÃ©es
# ============================================

@st.cache_resource
def connecter_bdd():
    """Se connecte Ã  la base de donnÃ©es PostgreSQL"""
    try:
        engine = create_engine("postgresql+psycopg2://postgres:malika123@localhost:5432/footballistiques")
        metadata = MetaData()
        
        # Charger les tables
        saison = Table("saison", metadata, autoload_with=engine)
        competition = Table("competition", metadata, autoload_with=engine)
        team = Table("team", metadata, autoload_with=engine)
        player = Table("player", metadata, autoload_with=engine)
        match = Table("match", metadata, autoload_with=engine)
        match_result = Table("match_result", metadata, autoload_with=engine)
        player_statistics = Table("player_statistics", metadata, autoload_with=engine)
        
        return engine, {
            "saison": saison,
            "competition": competition,
            "team": team,
            "player": player,
            "match": match,
            "match_result": match_result,
            "player_statistics": player_statistics
        }
    except Exception as e:
        st.error(f"Erreur de connexion Ã  la base de donnÃ©es : {e}")
        return None, None

# Connexion
engine, tables = connecter_bdd()

if engine is None:
    st.stop()

# ============================================
# 2. Fonctions pour rÃ©cupÃ©rer les donnÃ©es
# ============================================

def get_top_buteurs(nombre=10, equipe_filtre=None):
    """RÃ©cupÃ¨re le top N des meilleurs buteurs"""
    stmt = select(
        tables["player"].c.Player,
        tables["team"].c.team_name,
        func.sum(tables["player_statistics"].c.Gls).label("total_buts")
    ).join(
        tables["player_statistics"], 
        tables["player_statistics"].c.player_id == tables["player"].c.player_id
    ).join(
        tables["team"], 
        tables["player"].c.team_id == tables["team"].c.team_id
    )
    
    if equipe_filtre:
        stmt = stmt.where(tables["team"].c.team_name == equipe_filtre)
    
    stmt = stmt.group_by(
        tables["player"].c.Player, 
        tables["team"].c.team_name
    ).order_by(
        desc("total_buts")
    ).limit(nombre)
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Joueur", "Ã‰quipe", "Buts"])
    return df

def get_joueurs_decisifs(nombre=10, equipe_filtre=None):
    """RÃ©cupÃ¨re les joueurs les plus dÃ©cisifs"""
    stmt = select(
        tables["player"].c.Player,
        tables["team"].c.team_name,
        (func.sum(tables["player_statistics"].c.Gls) + func.sum(tables["player_statistics"].c.Ast)).label("total_decisive")
    ).join(
        tables["player_statistics"], 
        tables["player"].c.player_id == tables["player_statistics"].c.player_id
    ).join(
        tables["team"], 
        tables["player"].c.team_id == tables["team"].c.team_id
    )
    
    if equipe_filtre:
        stmt = stmt.where(tables["team"].c.team_name == equipe_filtre)
    
    stmt = stmt.group_by(
        tables["player"].c.Player, 
        tables["team"].c.team_name
    ).order_by(
        desc("total_decisive")
    ).limit(nombre)
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Joueur", "Ã‰quipe", "Total"])
    return df

def get_buts_par_equipe():
    """RÃ©cupÃ¨re le total de buts par Ã©quipe"""
    stmt = select(
        tables["team"].c.team_name,
        func.sum(tables["player_statistics"].c.Gls).label("total_buts")
    ).join(
        tables["player"], 
        tables["player"].c.team_id == tables["team"].c.team_id
    ).join(
        tables["player_statistics"], 
        tables["player_statistics"].c.player_id == tables["player"].c.player_id
    ).group_by(
        tables["team"].c.team_name
    ).order_by(
        desc("total_buts")
    )
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Ã‰quipe", "Buts"])
    return df

def get_classement():
    """RÃ©cupÃ¨re le classement des Ã©quipes"""
    stmt = select(
        tables["team"].c.team_name,
        func.sum(
            case(
                (tables["match_result"].c.Result == 'W', 3),
                (tables["match_result"].c.Result == 'D', 1),
                else_=0
            )
        ).label("points")
    ).join(
        tables["match"], 
        tables["match"].c.team_id == tables["team"].c.team_id
    ).join(
        tables["match_result"], 
        tables["match_result"].c.match_id == tables["match"].c.match_id
    ).group_by(
        tables["team"].c.team_name
    ).order_by(
        desc("points")
    )
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Ã‰quipe", "Points"])
    return df

def get_attaque_defense():
    """RÃ©cupÃ¨re moyenne buts marquÃ©s et encaissÃ©s"""
    stmt = select(
        tables["team"].c.team_name,
        func.avg(tables["match_result"].c.GF).label("moy_buts_marques"),
        func.avg(tables["match_result"].c.GA).label("moy_buts_encais")
    ).join(
        tables["match"], 
        tables["match"].c.team_id == tables["team"].c.team_id
    ).join(
        tables["match_result"], 
        tables["match_result"].c.match_id == tables["match"].c.match_id
    ).group_by(
        tables["team"].c.team_name
    )
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Ã‰quipe", "Buts MarquÃ©s", "Buts EncaissÃ©s"])
    return df

def get_meilleure_defense():
    """RÃ©cupÃ¨re les Ã©quipes avec la meilleure dÃ©fense"""
    stmt = select(
        tables["team"].c.team_name,
        func.sum(tables["match_result"].c.GA).label("buts_encaisses")
    ).join(
        tables["match"], 
        tables["match"].c.team_id == tables["team"].c.team_id
    ).join(
        tables["match_result"], 
        tables["match_result"].c.match_id == tables["match"].c.match_id
    ).group_by(
        tables["team"].c.team_name
    ).order_by(
        "buts_encaisses"
    )
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Ã‰quipe", "Buts EncaissÃ©s"])
    return df

def get_nationalites(equipe_filtre=None):
    """RÃ©cupÃ¨re la rÃ©partition des nationalitÃ©s"""
    stmt = select(
        tables["team"].c.team_name,
        tables["player"].c.Nation,
        func.count(tables["player"].c.player_id).label("nb_joueurs")
    ).join(
        tables["player"], 
        tables["player"].c.team_id == tables["team"].c.team_id
    )
    
    if equipe_filtre:
        stmt = stmt.where(tables["team"].c.team_name == equipe_filtre)
    
    stmt = stmt.group_by(
        tables["team"].c.team_name, 
        tables["player"].c.Nation
    ).order_by(
        tables["team"].c.team_name, 
        func.count(tables["player"].c.player_id).desc()
    )
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    df = pd.DataFrame(results, columns=["Ã‰quipe", "NationalitÃ©", "Nombre"])
    return df

def get_liste_equipes():
    """RÃ©cupÃ¨re la liste de toutes les Ã©quipes"""
    stmt = select(tables["team"].c.team_name).order_by(tables["team"].c.team_name)
    
    with engine.connect() as conn:
        results = conn.execute(stmt).fetchall()
    
    return [row[0] for row in results]

# ============================================
# 3. Fonctions pour les graphiques
# ============================================

def graphique_barres(df, x_col, y_col, titre, couleur_col=None):
    """CrÃ©e un graphique en barres simple"""
    if couleur_col:
        fig = px.bar(df, x=x_col, y=y_col, color=couleur_col, orientation='h', title=titre)
    else:
        fig = px.bar(df, x=x_col, y=y_col, orientation='h', title=titre)
    fig.update_layout(yaxis={'categoryorder': 'total ascending'}, height=400)
    return fig

def graphique_scatter(df, x_col, y_col, titre):
    """CrÃ©e un graphique scatter simple"""
    fig = px.scatter(df, x=x_col, y=y_col, size=x_col, hover_data=["Ã‰quipe"], title=titre)
    fig.update_layout(height=400)
    return fig

# ============================================
# 4. Interface principale
# ============================================

st.title("ðŸ“Š Dashboard Footballistiques - Premier League 2024-2025")
st.markdown("---")

# Menu de navigation
page = st.sidebar.selectbox(
    "Choisir une section",
    ["Accueil", "Statistiques Joueurs", "Statistiques Ã‰quipes"]
)

# Liste des Ã©quipes pour les filtres
equipes_liste = get_liste_equipes()

# ============================================
# Page Accueil
# ============================================
if page == "Accueil":
    st.header("Bienvenue sur le Dashboard")
    
    # RÃ©cupÃ©rer quelques statistiques
    classement = get_classement()
    buts_equipe = get_buts_par_equipe()
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Ã‰quipes", len(equipes_liste))
    with col2:
        st.metric("Ã‰quipe en tÃªte", classement.iloc[0]["Ã‰quipe"] if len(classement) > 0 else "N/A")
    with col3:
        st.metric("Points du leader", int(classement.iloc[0]["Points"]) if len(classement) > 0 else 0)
    with col4:
        st.metric("Total Buts", int(buts_equipe["Buts"].sum()))
    
    st.markdown("---")
    st.write("Utilisez le menu de gauche pour explorer les diffÃ©rentes sections.")

# ============================================
# Page Statistiques Joueurs
# ============================================
elif page == "Statistiques Joueurs":
    st.header("Statistiques des Joueurs")
    
    # Filtres
    st.subheader("Filtres")
    col1, col2 = st.columns(2)
    with col1:
        equipe_filtre = st.selectbox("Filtrer par Ã©quipe", ["Toutes"] + equipes_liste)
    with col2:
        nombre_joueurs = st.slider("Nombre de joueurs", 5, 20, 10)
    
    # Appliquer le filtre
    equipe_selectionnee = None if equipe_filtre == "Toutes" else equipe_filtre
    
    # RÃ©cupÃ©rer les donnÃ©es
    top_buteurs = get_top_buteurs(nombre_joueurs, equipe_selectionnee)
    joueurs_decisifs = get_joueurs_decisifs(nombre_joueurs, equipe_selectionnee)
    nationalites = get_nationalites(equipe_selectionnee)
    
    # Graphiques
    st.subheader("Graphiques")
    
    tab1, tab2, tab3 = st.tabs(["Meilleurs Buteurs", "Joueurs DÃ©cisifs", "NationalitÃ©s"])
    
    with tab1:
        fig1 = graphique_barres(top_buteurs, "Buts", "Joueur", "Top Meilleurs Buteurs", "Ã‰quipe")
        st.plotly_chart(fig1, use_container_width=True)
    
    with tab2:
        fig2 = graphique_barres(joueurs_decisifs, "Total", "Joueur", "Joueurs DÃ©cisifs (Buts + Passes)", "Ã‰quipe")
        st.plotly_chart(fig2, use_container_width=True)
    
    with tab3:
        # AgrÃ©ger par nationalitÃ©
        nat_agg = nationalites.groupby("NationalitÃ©")["Nombre"].sum().reset_index()
        nat_agg = nat_agg.sort_values("Nombre", ascending=False).head(15)
        fig3 = graphique_barres(nat_agg, "Nombre", "NationalitÃ©", "Top 15 NationalitÃ©s")
        st.plotly_chart(fig3, use_container_width=True)
    
    # Tableau interactif
    st.subheader("DonnÃ©es FiltrÃ©es - Meilleurs Buteurs")
    st.dataframe(top_buteurs, use_container_width=True, height=300)
    
    # Bouton de tÃ©lÃ©chargement
    csv_data = top_buteurs.to_csv(index=False).encode('utf-8')
    st.download_button(
        label="TÃ©lÃ©charger en CSV",
        data=csv_data,
        file_name=f"top_buteurs_{equipe_filtre.lower().replace(' ', '_')}.csv",
        mime="text/csv"
    )

# ============================================
# Page Statistiques Ã‰quipes
# ============================================
elif page == "Statistiques Ã‰quipes":
    st.header("Statistiques des Ã‰quipes")
    
    # RÃ©cupÃ©rer les donnÃ©es
    buts_equipe = get_buts_par_equipe()
    classement = get_classement()
    attaque_defense = get_attaque_defense()
    defense = get_meilleure_defense()
    
    # Graphiques
    st.subheader("Graphiques")
    
    tab1, tab2, tab3, tab4 = st.tabs(["Classement", "Buts par Ã‰quipe", "Attaque vs DÃ©fense", "Meilleure DÃ©fense"])
    
    with tab1:
        fig1 = graphique_barres(classement, "Points", "Ã‰quipe", "Classement des Ã‰quipes")
        st.plotly_chart(fig1, use_container_width=True)
    
    with tab2:
        fig2 = graphique_barres(buts_equipe, "Buts", "Ã‰quipe", "Total de Buts par Ã‰quipe")
        st.plotly_chart(fig2, use_container_width=True)
    
    with tab3:
        fig3 = graphique_scatter(attaque_defense, "Buts MarquÃ©s", "Buts EncaissÃ©s", "Attaque vs DÃ©fense")
        st.plotly_chart(fig3, use_container_width=True)
    
    with tab4:
        fig4 = graphique_barres(defense, "Buts EncaissÃ©s", "Ã‰quipe", "Meilleure DÃ©fense (moins de buts encaissÃ©s)")
        st.plotly_chart(fig4, use_container_width=True)
    
    # Tableau interactif - Classement
    st.subheader("DonnÃ©es FiltrÃ©es - Classement")
    
    # Fusionner les donnÃ©es pour un tableau complet
    tableau_complet = classement.merge(buts_equipe, on="Ã‰quipe", how="left")
    tableau_complet = tableau_complet.merge(
        attaque_defense[["Ã‰quipe", "Buts MarquÃ©s", "Buts EncaissÃ©s"]], 
        on="Ã‰quipe", 
        how="left"
    )
    
    st.dataframe(tableau_complet, use_container_width=True, height=400)
    
    # Bouton de tÃ©lÃ©chargement
    csv_data = tableau_complet.to_csv(index=False).encode('utf-8')
    st.download_button(
        label="TÃ©lÃ©charger en CSV",
        data=csv_data,
        file_name="statistiques_equipes.csv",
        mime="text/csv"
    )
